var Web3 = require('web3');
var async = require("async");
var web3 = new Web3();

var fs = require("fs");

var WEB3_RPC =  process.env.WEB3_RPC || 'http://ac5b2c490b76111e693b00216fd30015-1818368795.eu-west-1.elb.amazonaws.com:8545';
//var WEB3_RPC =  "http://vps261196.ovh.net:8545";

var deviceContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"setOwner","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionOutput","type":"string"}],"name":"enableOutput","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionOutput","type":"string"}],"name":"disabelOutput","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionInput","type":"string"}],"name":"disabelInput","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionInput","type":"string"}],"name":"enableInput","outputs":[],"payable":false,"type":"function"},{"inputs":[],"payable":false,"type":"constructor"}]);
var personalContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_device","type":"address"}],"name":"removeDevice","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"mapConsumers","outputs":[{"name":"device","type":"address"},{"name":"service","type":"address"},{"name":"action","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_device","type":"address"},{"name":"_service","type":"address"},{"name":"_action","type":"string"}],"name":"addConsumer","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_device","type":"address"},{"name":"_service","type":"address"},{"name":"_action","type":"string"}],"name":"removeConsumer","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_device","type":"address"}],"name":"addDevice","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_action","type":"string"},{"name":"_service","type":"address"}],"name":"getConsummer","outputs":[{"name":"_devices","type":"address[]"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"test","outputs":[{"name":"","type":"address[]"}],"payable":false,"type":"function"}]);
var serviceContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_actionOutput","type":"string"}],"name":"enableOutput","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionOutput","type":"string"}],"name":"disabelOutput","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionInput","type":"string"}],"name":"disabelInput","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionInput","type":"string"}],"name":"enableInput","outputs":[],"payable":false,"type":"function"}]);

web3.setProvider(new web3.providers.HttpProvider(WEB3_RPC));
web3.eth.defaultAccount = web3.eth.accounts[0];
console.log(web3.eth.defaultAccount);

function deployService(next) {
    serviceContract.new(
        {
            from: web3.eth.accounts[0],
            data: '0x606060405234610000575b6103ff806100196000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806340efb5611461005f578063aa67dea4146100b6578063f8e5f1f41461010d578063fc76a9ee14610164575b610000565b34610000576100b4600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506101bb565b005b346100005761010b600480803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610241565b005b3461000057610162600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506102c7565b005b34610000576101b9600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190505061034d565b005b60016001826040518082805190602001908083835b602083106101f357805182526020820191506020810190506020830392506101d0565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505b50565b60006001826040518082805190602001908083835b602083106102795780518252602082019150602081019050602083039250610256565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505b50565b60006000826040518082805190602001908083835b602083106102ff57805182526020820191506020810190506020830392506102dc565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505b50565b60016000826040518082805190602001908083835b602083106103855780518252602082019150602081019050602083039250610362565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505b505600a165627a7a7230582021c061999a1fbc266eb1f2a2617131ed8890cc2b7612631e708756617d44f2eb0029',
            gas: '4700000'
        }, function (err, contract){
            if (err) {
                return next(err);
            }

            if (typeof contract.address !== 'undefined') {
                console.log('Contract mined! SERVICE address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                next(null, contract);
            }
        })
}


function deployPerson(next) {
    personalContract.new(
        {
            from: web3.eth.defaultAccount,
            data: '0x606060405234610000575b611375806100196000396000f30060606040523615610081576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680631f7b63241461008657806322858fc9146100b95780633e138a11146101d2578063a88c3c4014610267578063b111cb84146102fc578063c3df6f0e1461032f578063f8a8fd6d14610408575b610000565b34610000576100b7600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190505061047a565b005b34610000576100d460048080359060200190919050506105e8565b604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001806020018281038252838181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156101c15780601f10610196576101008083540402835291602001916101c1565b820191906000526020600020905b8154815290600101906020018083116101a457829003601f168201915b505094505050505060405180910390f35b3461000057610265600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190505061065e565b005b34610000576102fa600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610a84565b005b346100005761032d600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610e88565b005b34610000576103a3600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610f28565b60405180806020018281038252838181518152602001915080519060200190602002808383600083146103f5575b8051825260208311156103f5576020820191506020810190506020830392506103d1565b5050509050019250505060405180910390f35b34610000576104156111a6565b6040518080602001828103825283818151815260200191508051906020019060200280838360008314610467575b80518252602083111561046757602082019150602081019050602083039250610443565b5050509050019250505060405180910390f35b6000600090505b6000805490508110156105e3578173ffffffffffffffffffffffffffffffffffffffff16600082815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156105d5576000600160008054905003815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600082815481101561000057906000526020600020900160005b6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000600160008054905003815481101561000057906000526020600020900160005b6101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690555b5b8080600101915050610481565b5b5050565b600581815481101561000057906000526020600020906003020160005b915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169080600201905083565b6060604051908101604052808473ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff16815260200182815250600160008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506040820151816002019080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061078857805160ff19168380011785556107b6565b828001600101855582156107b6579182015b828111156107b557825182559160200191906001019061079a565b5b5090506107db91905b808211156107d75760008160009055506001016107bf565b5090565b5050905050600580548060010182818154818355818115116108d9576003028160030283600052602060002091820191016108d891905b808211156108d45760006000820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556001820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905560028201805460018160011615610100020316600290046000825580601f1061089357506108ca565b601f0160209004906000526020600020908101906108c991905b808211156108c55760008160009055506001016108ad565b5090565b5b5050600301610812565b5090565b5b505050916000526020600020906003020160005b600190919091506000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060028201816002019080546001816001161561010002031660029004828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610a175780548555610a54565b82800160010185558215610a5457600052602060002091601f016020900482015b82811115610a53578254825591600101919060010190610a38565b5b509050610a7991905b80821115610a75576000816000905550600101610a5d565b5090565b50505050505b505050565b60006000611a0a91505b600580549050811015610bd057610ac5600582815481101561000057906000526020600020906003020160005b50600201846111bb565b8015610b3d57508373ffffffffffffffffffffffffffffffffffffffff16600582815481101561000057906000526020600020906003020160005b5060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b8015610bb557508473ffffffffffffffffffffffffffffffffffffffff16600582815481101561000057906000526020600020906003020160005b5060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b15610bc257809150610bd0565b5b8080600101915050610a8e565b611a0a82141515610e80576005600160058054905003815481101561000057906000526020600020906003020160005b50600583815481101561000057906000526020600020906003020160005b506000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060028201816002019080546001816001161561010002031660029004828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610d425780548555610d7f565b82800160010185558215610d7f57600052602060002091601f016020900482015b82811115610d7e578254825591600101919060010190610d63565b5b509050610da491905b80821115610da0576000816000905550600101610d88565b5090565b50509050506005600160058054905003815481101561000057906000526020600020906003020160005b6000820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556001820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905560028201805460018160011615610100020316600290046000825580601f10610e455750610e7c565b601f016020900490600052602060002090810190610e7b91905b80821115610e77576000816000905550600101610e5f565b5090565b5b5050505b5b5050505050565b60008054806001018281815481835581811511610ed157818360005260206000209182019101610ed091905b80821115610ecc576000816000905550600101610eb4565b5090565b5b505050916000526020600020900160005b83909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505b50565b60206040519081016040528060008152506000600480546000825590600052602060002090810190610f7291905b80821115610f6e576000816000905550600101610f56565b5090565b5b505b60058054905081101561111557610fac600582815481101561000057906000526020600020906003020160005b50600201856111bb565b801561102457508273ffffffffffffffffffffffffffffffffffffffff16600582815481101561000057906000526020600020906003020160005b5060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b1561110757600480548060010182818154818355818115116110725781836000526020600020918201910161107191905b8082111561106d576000816000905550600101611055565b5090565b5b505050916000526020600020900160005b600584815481101561000057906000526020600020906003020160005b5060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505b5b8080600101915050610f75565b600480548060200260200160405190810160405280929190818152602001828054801561119757602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001906001019080831161114d575b505050505091505b5092915050565b60206040519081016040528060008152505b90565b60006000602060405190810160405280600081525060008592508491508151838054600181600116156101000203166002900490501415156112005760009350611340565b600090505b8280546001816001161561010002031660029004905081101561133b5781818151811015610000579060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000027effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916838281546001816001161561010002031660029004811015610000578154600116156112d55790600052602060002090602091828204019190065b9054901a7f0100000000000000000000000000000000000000000000000000000000000000027effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614151561132d5760009350611340565b5b8080600101915050611205565b600193505b505050929150505600a165627a7a72305820c1c060690df3ae1ed0c52a6863d5a8f3026d22334cfba75e878bf006b59ef18c0029',
            gas: '4700000'
        }, function (err, contract){
            if (err) {
                return next(err);
            }

            if (typeof contract.address !== 'undefined') {
                console.log('Contract mined! PERSON address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                next(null, contract);
            }

        });
}

function deployDevice(next) {
    deviceContract.new(
        {
            from: web3.eth.accounts[0],
            data: '0x606060405234610000575b33600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b5b6105088061005c6000396000f30060606040523615610076576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806313af40351461007b57806340efb561146100ae5780638da5cb5b14610105578063aa67dea414610154578063f8e5f1f4146101ab578063fc76a9ee14610202575b610000565b34610000576100ac600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610259565b005b3461000057610103600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190505061029e565b005b3461000057610112610324565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34610000576101a9600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190505061034a565b005b3461000057610200600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506103d0565b005b3461000057610257600480803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610456565b005b80600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b50565b60016001826040518082805190602001908083835b602083106102d657805182526020820191506020810190506020830392506102b3565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505b50565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60006001826040518082805190602001908083835b60208310610382578051825260208201915060208101905060208303925061035f565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505b50565b60006000826040518082805190602001908083835b6020831061040857805182526020820191506020810190506020830392506103e5565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505b50565b60016000826040518082805190602001908083835b6020831061048e578051825260208201915060208101905060208303925061046b565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505b505600a165627a7a7230582030fdb46ff8d8e1982997f9cdc56021664d6ae62febab3e72562b03c164d5daa70029',
            gas: '4700000'
        }, function (err, contract){
            if (err) {
                return next(err);
            }

            if (typeof contract.address !== 'undefined') {
                console.log('Contract mined! DEVICE address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
                next(null, contract);
            }
        });
}


function doDeploy(cb) {
    var funcs = [];
    var personAddress, deviceAddresses, serviceAddress;
    deviceAddresses = [];
    funcs.push(function(next) {
        deployDevice(function(err, response) {
            if (err) {
                return next(err);
            }
            if (response.address) {
                deviceAddresses.push(response.address);
                next();
            }
        });
    });
    funcs.push(function(next) {
        deployDevice(function(err, response) {
            if (err) {
                return next(err);
            }
            if (response.address) {
                deviceAddresses.push(response.address);
                next();
            }
        });
    });
    funcs.push(function(next) {
        deployDevice(function(err, response) {
            if (err) {
                return next(err);
            }
            if (response.address) {
                deviceAddresses.push(response.address);
                next();
            }
        });
    });
    funcs.push(function(next) {
        deployDevice(function(err, response) {
            if (err) {
                return next(err);
            }
            if (response.address) {
                deviceAddresses.push(response.address);
                next();
            }
        });
    });
    funcs.push(function(next) {
        deployPerson(function(err, response) {
            if (err) {
                return next(err);
            }
            if (response.address) {
                personAddress = response.address;
                next();
            }
        });
    });
    funcs.push(function(next) {
        deployService(function(err, response) {
            if (err) {
                return next(err);
            }
            if (response.address) {
                serviceAddress = response.address;
                next();
            }
        });
    });

    async.parallel(funcs, function(err) {
        if (err) {
            return console.error(err);
        }

        linkDevicesAndOwners(personAddress, serviceAddress, deviceAddresses, cb);
    });

}

function linkDevicesAndOwners(personAddress, serviceAddress, deviceAddresses, next) {
    var fn = [];

    fn.push(function (next) {
        for (var i = 0; i < deviceAddresses.length; i++) {
            var deviceAddress = deviceAddresses[i];
            var device = deviceContract.at(deviceAddress);
            device.setOwner.sendTransaction(personAddress, { gas: 4000000, from: web3.eth.defaultAccount}, function (err, response) {
                if (err) {
                    return next(err);
                }
                console.log(response);
            });
        }
        next();
    });

    var person = personalContract.at(personAddress);

    fn.push(function (next) {
        person.addConsumer.sendTransaction(deviceAddresses[0], serviceAddress, "TEXT", { gas: 400000, from: web3.eth.defaultAccount}, function (err, response) {
            if (err) {
                return next(err);
            }
            console.log(response);
            next();
        });
    });

    fn.push(function (next) {
        person.addConsumer.sendTransaction(deviceAddresses[1], serviceAddress, "TEXT", { gas: 400000, from: web3.eth.defaultAccount}, function (err, response) {
            if (err) {
                return next(err);
            }
            console.log(response);
            next();
        });
    });

    fn.push(function (next) {
        person.addConsumer.sendTransaction(deviceAddresses[2], serviceAddress, "BOOL", { gas: 400000, from: web3.eth.defaultAccount},function (err, response) {
            if (err) {
                return next(err);
            }
            console.log(response);
            next();
        });
    });

    async.parallel(fn, function (err) {
        if (err) {
            console.error(err);
            return;
        }
        var config = {
            serviceAddress: serviceAddress,
            personAddress: personAddress,
            slackService: deviceAddresses[0],
            smsService: deviceAddresses[1],
            alarmService: deviceAddresses[2],
            deviceAddress: deviceAddresses[3],
        };

        var data = "module.exports = " + JSON.stringify(config, null, 4);

        fs.writeFileSync("../../routes/config.js", data );


        console.log("DONE");
        next(null, "Done");
    });
}
module.exports = {
    doDeploy: doDeploy
};
