var Web3 = require('web3');
var web3 = new Web3();

//var WEB3_RPC =  process.env.WEB3_RPC || 'http://ac5b2c490b76111e693b00216fd30015-1818368795.eu-west-1.elb.amazonaws.com:8545';
var WEB3_RPC =  "http://vps261196.ovh.net:8545";

var DEVICE_CONTRACT = process.env.DEVICE_CONTRACT || "0x228b1290ce8c1718bad99cd8fc1b7fc0a65196ad";
var PERSONAL_CONTRACT = process.env.PERSONAL_CONTRACT || "0x190f6e23398f1cc55c4c24bb3ab109d25f8cf2bc";
var SERVICE_CONTRACT = process.env.SERVICE_CONTRACT || "0x515b272d7876687294432dc4c4f3a92984851430";

var deviceContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_actionOutput","type":"string"}],"name":"enableOutput","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionOutput","type":"string"}],"name":"disabelOutput","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionInput","type":"string"}],"name":"disabelInput","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionInput","type":"string"}],"name":"enableInput","outputs":[],"payable":false,"type":"function"},{"inputs":[],"payable":false,"type":"constructor"}]);
var personalContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_device","type":"address"}],"name":"removeDevice","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"mapConsumers","outputs":[{"name":"device","type":"address"},{"name":"service","type":"address"},{"name":"action","type":"string"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_device","type":"address"},{"name":"_service","type":"address"},{"name":"_action","type":"string"}],"name":"addConsumer","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_device","type":"address"},{"name":"_service","type":"address"},{"name":"_action","type":"string"}],"name":"removeConsumer","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_device","type":"address"}],"name":"addDevice","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_action","type":"string"},{"name":"_service","type":"address"}],"name":"getConsummer","outputs":[{"name":"_devices","type":"address[]"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"test","outputs":[{"name":"","type":"address[]"}],"payable":false,"type":"function"}]);
var serviceContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_actionOutput","type":"string"}],"name":"enableOutput","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionOutput","type":"string"}],"name":"disabelOutput","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionInput","type":"string"}],"name":"disabelInput","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionInput","type":"string"}],"name":"enableInput","outputs":[],"payable":false,"type":"function"}]);

//deviceInstance = deviceContract.at(DEVICE_CONTRACT);
//personalInstance = personalContract.at(PERSONAL_CONTRACT);
//erviceInstance = serviceContract.at(SERVICE_CONTRACT);

// -DEPENDENCIES
web3.setProvider(new web3.providers.HttpProvider(WEB3_RPC));
web3.eth.defaultAccount = web3.eth.accounts[0];
console.log(web3.eth.defaultAccount);

/*
personalInstance.addConsumer.sendTransaction("0x0362596aa8aba98c7161aed5080f5994d46cfbaf","0x0362596aa8aba98c7161aed5080f5994d46cfbaf", "TEXT", {
    gas: 4000000,
    from: web3.eth.defaultAccount
});
*/

function whoOwnsDevice(args, next) {
    if (!args) {
        return next({message: "args is required."});
    }
    if (!args.deviceID) {
        return next({message: "args.deviceID is required."});
    }

    var device = deviceContract.at(args.deviceID);
    console.log(device.owner);

    device.owner.call(function (err, value) {
        if (err) {
            return next(err);
        }

        console.log("THE OWNER WAS:", value);
        next(null, value);
    });
}

function getConsumers(args, next) {
    if (!args) {
        return next({message: "args is required."});
    }
    if (!args.action) {
        return next({message: "args.action is required."});
    }
    if (!args.owner) {
        return next({message: "args.owner is required."});
    }
    if (!args.serviceAddress) {
        return next({message: "args.serviceAddress is required."});
    }

    var person = personalContract.at(args.owner);
    var consumers = [];
    try {
        for (var i = 0; i < 999; i++) {
            var consumer = person.mapConsumers.call(i);
            if (consumer[2] == args.action && consumer[1] == args.serviceAddress) {
                consumers.push(consumer);
            }
        }
    } catch(e) {
        console.log("DONE");
    }

    next(null, consumers);
}

function deployDevice() {
    var deviceContract = web3.eth.contract([{"constant":false,"inputs":[{"name":"_actionOutput","type":"string"}],"name":"enableOutput","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionOutput","type":"string"}],"name":"disabelOutput","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionInput","type":"string"}],"name":"disabelInput","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_actionInput","type":"string"}],"name":"enableInput","outputs":[],"payable":false,"type":"function"},{"inputs":[],"payable":false,"type":"constructor"}]);
    deviceContract.new(
        {
            from: web3.eth.defaultAccount,
            data: '0x606060405234610000575b33600460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505b5b61047f8061005c6000396000f30060606040526000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806340efb5611461006a5780638da5cb5b146100c1578063aa67dea414610110578063f8e5f1f414610167578063fc76a9ee146101be575b610000565b34610000576100bf600480803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610215565b005b34610000576100ce61029b565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3461000057610165600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506102c1565b005b34610000576101bc600480803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610347565b005b3461000057610213600480803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506103cd565b005b60016001826040518082805190602001908083835b6020831061024d578051825260208201915060208101905060208303925061022a565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505b50565b600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60006001826040518082805190602001908083835b602083106102f957805182526020820191506020810190506020830392506102d6565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505b50565b60006000826040518082805190602001908083835b6020831061037f578051825260208201915060208101905060208303925061035c565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505b50565b60016000826040518082805190602001908083835b6020831061040557805182526020820191506020810190506020830392506103e2565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055505b505600a165627a7a7230582018ebd04771812ce19b69df3f66e069c6fec72e8f7889f68c8e0f2ba7ac304b5c0029',
            gas: '4700000'
        }, function (err, contract){
            if (err) {
                return next(err);
            }

            if (typeof contract.address !== 'undefined') {
                console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
            }
        });
}

function deployPerson() {
    deviceContract.new(
        {
            from: web3.eth.defaultAccount,
            data: '606060405234610000575b6111db806100196000396000f30060606040523615610076576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680631f7b63241461007b5780633e138a11146100ae578063a88c3c4014610143578063b111cb84146101d8578063c3df6f0e1461020b578063f8a8fd6d146102e4575b610000565b34610000576100ac600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610356565b005b3461000057610141600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506104c4565b005b34610000576101d6600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506108ea565b005b3461000057610209600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610cee565b005b346100005761027f600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610d8e565b60405180806020018281038252838181518152602001915080519060200190602002808383600083146102d1575b8051825260208311156102d1576020820191506020810190506020830392506102ad565b5050509050019250505060405180910390f35b34610000576102f161100c565b6040518080602001828103825283818151815260200191508051906020019060200280838360008314610343575b8051825260208311156103435760208201915060208101905060208303925061031f565b5050509050019250505060405180910390f35b6000600090505b6000805490508110156104bf578173ffffffffffffffffffffffffffffffffffffffff16600082815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614156104b1576000600160008054905003815481101561000057906000526020600020900160005b9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600082815481101561000057906000526020600020900160005b6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000600160008054905003815481101561000057906000526020600020900160005b6101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690555b5b808060010191505061035d565b5b5050565b6060604051908101604052808473ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff16815260200182815250600160008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506040820151816002019080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106105ee57805160ff191683800117855561061c565b8280016001018555821561061c579182015b8281111561061b578251825591602001919060010190610600565b5b50905061064191905b8082111561063d576000816000905550600101610625565b5090565b50509050506005805480600101828181548183558181151161073f5760030281600302836000526020600020918201910161073e91905b8082111561073a5760006000820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556001820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905560028201805460018160011615610100020316600290046000825580601f106106f95750610730565b601f01602090049060005260206000209081019061072f91905b8082111561072b576000816000905550600101610713565b5090565b5b5050600301610678565b5090565b5b505050916000526020600020906003020160005b600190919091506000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060028201816002019080546001816001161561010002031660029004828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061087d57805485556108ba565b828001600101855582156108ba57600052602060002091601f016020900482015b828111156108b957825482559160010191906001019061089e565b5b5090506108df91905b808211156108db5760008160009055506001016108c3565b5090565b50505050505b505050565b60006000611a0a91505b600580549050811015610a365761092b600582815481101561000057906000526020600020906003020160005b5060020184611021565b80156109a357508373ffffffffffffffffffffffffffffffffffffffff16600582815481101561000057906000526020600020906003020160005b5060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b8015610a1b57508473ffffffffffffffffffffffffffffffffffffffff16600582815481101561000057906000526020600020906003020160005b5060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b15610a2857809150610a36565b5b80806001019150506108f4565b611a0a82141515610ce6576005600160058054905003815481101561000057906000526020600020906003020160005b50600583815481101561000057906000526020600020906003020160005b506000820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060028201816002019080546001816001161561010002031660029004828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610ba85780548555610be5565b82800160010185558215610be557600052602060002091601f016020900482015b82811115610be4578254825591600101919060010190610bc9565b5b509050610c0a91905b80821115610c06576000816000905550600101610bee565b5090565b50509050506005600160058054905003815481101561000057906000526020600020906003020160005b6000820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff02191690556001820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff021916905560028201805460018160011615610100020316600290046000825580601f10610cab5750610ce2565b601f016020900490600052602060002090810190610ce191905b80821115610cdd576000816000905550600101610cc5565b5090565b5b5050505b5b5050505050565b60008054806001018281815481835581811511610d3757818360005260206000209182019101610d3691905b80821115610d32576000816000905550600101610d1a565b5090565b5b505050916000526020600020900160005b83909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505b50565b60206040519081016040528060008152506000600480546000825590600052602060002090810190610dd891905b80821115610dd4576000816000905550600101610dbc565b5090565b5b505b600580549050811015610f7b57610e12600582815481101561000057906000526020600020906003020160005b5060020185611021565b8015610e8a57508273ffffffffffffffffffffffffffffffffffffffff16600582815481101561000057906000526020600020906003020160005b5060010160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b15610f6d5760048054806001018281815481835581811511610ed857818360005260206000209182019101610ed791905b80821115610ed3576000816000905550600101610ebb565b5090565b5b505050916000526020600020900160005b600584815481101561000057906000526020600020906003020160005b5060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505b5b8080600101915050610ddb565b6004805480602002602001604051908101604052809291908181526020018280548015610ffd57602002820191906000526020600020905b8160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019060010190808311610fb3575b505050505091505b5092915050565b60206040519081016040528060008152505b90565b600060006020604051908101604052806000815250600085925084915081518380546001816001161561010002031660029004905014151561106657600093506111a6565b600090505b828054600181600116156101000203166002900490508110156111a15781818151811015610000579060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000027effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19168382815460018160011615610100020316600290048110156100005781546001161561113b5790600052602060002090602091828204019190065b9054901a7f0100000000000000000000000000000000000000000000000000000000000000027effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614151561119357600093506111a6565b5b808060010191505061106b565b600193505b505050929150505600a165627a7a72305820ff6c899393c038384839efb542326fce951926caa66841aa5a2ca35f8be844d60029',
            gas: '4700000'
        }, function (err, contract){
            if (err) {
                console.error(err);
                return;
            }

            if (typeof contract.address !== 'undefined') {
                console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
            }
        });

}

function addConsumer() {
    personalInstance.addConsumer.sendTransaction("0x0362596aa8aba98c7161aed5080f5994d46cfbaf","0x0362596aa8aba98c7161aed5080f5994d46cfbaf", "TEXT", {
        gas: 4000000,
        from: web3.eth.defaultAccount
    });
}

function deployServiceContract() {
    serviceContract.new(
        {
            from: web3.eth.defaultAccount,
            data: '',
            gas: '4700000'
        }, function (err, contract) {
            if (err) {
                console.error(err);
                return;
            }

            if (contract.address) {
                console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
            }
        }
    )
}

function setOwner(args, next) {
    if (!args) {
        return next({message: "args is required."});
    }
    if (!args.owner) {
        return next({message: "args.owner is required."});
    }
    if (!args.deviceID) {
        return next({message: "args.deviceID is required."});
    }

    var device = deviceContract.at(args.deviceID);

    device.owner.sendTransaction(args.owner, { gas: 4000000, from: web3.eth.defaultAccount }, next);
}

module.exports = {
    whoOwnsDevice: whoOwnsDevice,
    getConsumers: getConsumers
};